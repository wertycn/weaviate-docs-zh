---
image: og/docs/concepts.jpg
sidebar_position: 3
title: Cluster Architecture
---

import Badges from '/_includes/badges.mdx';

<Badges/>

本页面描述了Weaviate的复制设计中的节点或集群如何以无领导者的方式运行。

## 无领导者设计

在Weaviate中，复制是无领导者的。这意味着没有中央领导者或主节点来复制给从节点。相反，所有节点都可以接受客户端的写入和读取操作，这可以提供更好的可用性。没有单点故障。无领导者的复制方法也被称为[Dynamo风格](https://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf)的数据复制，被亚马逊使用，并且也被其他开源项目如[Apache Cassandra](https://cassandra.apache.org)实施。

在Weaviate中，使用协调模式将客户端的读写请求传递给正确的节点。与基于领导者的数据库不同，协调节点不会强制执行任何操作的顺序。

下图显示了Weaviate中的无领导复制设计。有一个协调节点，负责将客户端的流量引导到正确的副本。这个节点并没有特别之处；它被选择为协调器是因为这个节点接收了负载均衡器的请求。将来对相同数据的请求可能由不同的节点协调处理。

<p align="center"><img src="/img/docs/replication-architecture/replication-main-quorum.png" alt="复制架构" width="75%"/></p>

无领导复制设计的主要优势是提高了容错性。没有一个处理所有请求的领导者，无领导设计提供了更好的可用性。在单领导者设计中，所有写操作都需要由该领导者处理。如果该节点无法访问或宕机，将无法处理任何写操作。而在无领导设计中，所有节点都可以接收写操作，因此不存在一个主节点故障的风险。

在高可用性的反面，无领导数据库往往不太一致。因为没有领导节点，不同节点上的数据可能会暂时过时。无领导数据库往往是最终一致的。在Weaviate中，一致性是可调节的，但这是以可用性为代价的。

## 复制因子

在Weaviate中，复制功能是按类别启用和控制的。这意味着您可以为不同的类别设置不同的复制因子。

复制因子（RF或n）决定了在分布式环境中存储数据的副本数量。复制因子为1意味着在数据库设置中只有每个数据条目的1个副本，换句话说，没有复制。复制因子为2意味着每个数据条目有两个副本，分别存在于两个不同的节点（副本）。显然，复制因子不能大于节点数。集群中的任何节点都可以作为协调节点，将查询引导到正确的目标节点。

通常使用3个副本因子，因为这在性能和容错之间提供了适当的平衡。一般情况下，偏好使用奇数个节点，因为这样更容易解决冲突。在一个3节点的设置中，可以通过2个节点达到法定人数。因此，容错能力为1个节点。另一方面，在一个2节点的设置中，无法容忍任何节点故障，同时仍然在节点之间达成共识。在一个4节点的设置中，需要3个节点才能达成共识。因此，一个3节点的设置在容错性和成本之间有更好的比例，而不是2节点或4节点的设置。

<p align="center"><img src="/img/docs/replication-architecture/replication-factor.png" alt="复制因子" width="75%"/></p>

## 写操作

在写操作中，客户端的请求将被发送到集群中的任何一个节点。第一个接收请求的节点被分配为协调器。协调器节点将请求发送到一些预定义的副本，并将结果返回给客户端。因此，集群中的任何一个节点都可以成为协调器节点。客户端只与该协调器节点直接联系。在将结果返回给客户端之前，协调器节点会等待一定数量的写操作确认，具体数量取决于配置。Weaviate等待的确认数量取决于[一致性配置](./consistency.md)。

**步骤**
1. 客户端将数据发送给任何一个节点，该节点将被指定为协调节点
2. 协调节点将数据发送给集群中的一个以上的副本节点
3. 协调节点等待来自x个节点的确认。从v1.18开始，x是[可配置的](./consistency.md)，默认为`ALL`节点。
4. 当协调节点收到x个确认时，写入操作成功完成。

作为一个例子，考虑一个集群大小为3，复制因子为3的情况。因此，分布式设置中的所有节点都包含数据的副本。当客户端发送新数据时，它将被复制到所有三个节点。

<p align="center"><img src="/img/docs/replication-architecture/replication-rf3-size3.png" alt="集群大小为3的复制因子为3" width="75%"/></p>

对于一个集群大小为8，复制因子为3的情况下，写操作将不会发送到所有8个节点，而只会发送到包含副本的那三个节点。协调节点将确定数据将被写入哪些节点。存储哪些类别（分片）的节点是由Weaviate的设置确定的，每个节点和协调节点都知道这一点。数据复制的位置是确定的，因此所有节点都知道哪个数据将落在哪个分片上。

<p align="center"><img src="/img/docs/replication-architecture/replication-rf3-size8.png" alt="复制因子为3，集群大小为8" width="75%"/></p>

## 读操作

读操作也由协调节点协调，将查询定向到包含数据的正确节点。由于一个或多个节点可能包含旧（过时）数据，在将数据发送给用户之前，读取客户端将确定接收到的数据中最新的数据。

**步骤**
1. 客户端向Weaviate发送查询请求，集群中任何一个首先接收到请求的节点都将充当协调节点
2. 协调节点将查询发送给集群中的多个副本节点
3. 协调节点等待来自x个节点的响应。*x是[可配置的](./consistency.md)（从v1.18开始可用的`ALL`，`QUORUM`或`ONE`，从v1.17开始，按ID获取对象的请求具有可调整的一致性）*
4. 协调节点使用一些元数据（例如时间戳、ID、版本号）解决冲突的数据。
5. 协调节点将最新的数据返回给客户端。

如果集群大小为3，并且副本因子也为3，则所有节点都可以提供查询服务。一致性级别决定了将查询哪些节点。

如果集群大小为10，复制因子为3，则包含该数据（类）的3个节点可以通过协调节点来处理查询。客户端会等待直到x（一致性级别）个节点响应。

## 更多资源

import DocsMoreResources from '/_includes/more-resources-docs.md';

<DocsMoreResources />